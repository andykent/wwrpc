(function(){var WWRPC;window.WWRPC=WWRPC={},WWRPC.defineProtocol=function(t){return new WWRPC.Protocol(t)},WWRPC.spawnWorker=function(t,n){return new WWRPC.Worker(t,n)},WWRPC.remote=function(t){return new WWRPC.RemoteFunction(t)},WWRPC.local=function(t){return new WWRPC.LocalFunction(t)},WWRPC.pass=function(t){return new WWRPC.PassFunction(t)},WWRPC.bridgeCode=function(t){return"var "+t+" = ("+(""+WWRPC.BRIDGE)+")();"},WWRPC.BRIDGE=function(){return{WAITING_CALLBACKS:[],unpack:function(obj,binding){var key,value;null==binding&&(binding={});for(key in obj)value=obj[key],binding[key]="object"==typeof value?this.unpack(value):"string"==typeof value&&0===value.search(/^function/)?eval("("+value+")"):value;return binding},init:function(){var t=this;return addEventListener("message",function(n){return t.process(n.data)})},process:function(data){switch(data.action){case"wwrpc:run":return eval("("+data.code+")()");case"wwrpc:callback":return this.runCallback(data.callbackId,data.args)}},runCallback:function(t,n){return this.WAITING_CALLBACKS[t].apply(n,n)},queueCallback:function(t){return this.WAITING_CALLBACKS.push(t),this.WAITING_CALLBACKS.length-1},call:function(t,n){var o;return null==n&&(n=[]),o=null,n.length>0&&"function"==typeof n[n.length-1]&&(o=this.queueCallback(n.pop())),postMessage({action:"wwrpc:call",name:t,args:n,callbackId:o})}}},WWRPC.Protocol=function(){function t(t){this.template=t}return t.prototype.workerCode=function(t){var n;return n=JSON.stringify(this.process(this.template,t)),""+WWRPC.bridgeCode("__bridge__")+"\n__bridge__.unpack("+n+", self);\n__bridge__.init();"},t.prototype.processLeaf=function(t,n,o){var r,e,i;null==o&&(o=[]),e={};for(r in t)i=t[r],e[r]=this.process(i,n,o.concat([r]));return console.log(e),e},t.prototype.process=function(t,n,o){return null==o&&(o=[]),t.constructor===WWRPC.PassFunction?t.resultForContext(n):t.constructor===WWRPC.RemoteFunction?t.toRpcString(o):t.constructor===WWRPC.LocalFunction?t.toRpcString(o):"object"==typeof t?this.processLeaf(t,n,o):t},t.prototype.call=function(t,n,o,r){var e;if(null==r&&(r=null),e=this.findFn(t),!e)throw Error("Undefined RPC function "+t+" called.");return e.run(n,o,r)},t.prototype.findFn=function(t){var n,o,r,e,i;for(o=t.split("."),r=this.template,e=0,i=o.length;i>e;e++)n=o[e],void 0!==r&&(r=r[n]);return r},t}(),WWRPC.RemoteFunction=function(){function t(t){this.fn=t}return t.prototype.run=function(t,n,o){return null!==o&&n.push(o),this.fn.apply(t,n)},t.prototype.toRpcString=function(t){return"function() { __bridge__.call('"+t.join(".")+"', Array.prototype.slice.apply(arguments)); }"},t}(),WWRPC.LocalFunction=function(){function t(t){this.fn=t}return t.prototype.toRpcString=function(){return""+this.fn},t}(),WWRPC.PassFunction=function(){function t(t){this.fn=t}return t.prototype.resultForContext=function(t){return this.fn.apply(t,t)},t}(),WWRPC.Worker=function(){function t(t,n){this.protocol=t,this.context=null!=n?n:{},this.blob=new Blob([this.protocol.workerCode(this.context)],{type:"text/javascript"}),this.start()}return t.prototype.process=function(t){switch(console.log(t),t.action){case"wwrpc:call":return this.protocol.call(t.name,this.context,t.args,this.buildCallback(t.callbackId))}},t.prototype.buildCallback=function(t){var n=this;return null===t?null:function(){return n.worker.postMessage({action:"wwrpc:callback",callbackId:t,args:Array.prototype.slice.apply(arguments)})}},t.prototype.terminate=function(){return this.worker.terminate(),this.worker=null},t.prototype.on=function(){},t.prototype.trigger=function(){},t.prototype.start=function(){var t=this;return this.worker=new window.Worker(window.URL.createObjectURL(this.blob)),this.worker.addEventListener("message",function(n){return t.process(n.data)})},t.prototype.loadCode=function(t){return console.log("loading code",""+t),this.worker.postMessage({action:"wwrpc:run",code:""+t})},t}()}).call(this);